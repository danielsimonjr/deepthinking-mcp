{
  "phase": 13,
  "title": "Visual Exporter Refactoring",
  "description": "Utility module adoption for visual exporters - using shared DOT, Mermaid, and ASCII utilities instead of duplicating logic inline. File size reduction below 1000 lines is a natural consequence of this modular approach.",
  "totalSprints": 3,
  "totalEstimatedHours": 42,
  "status": "planned",
  "sprints": [
    {
      "sprint": 1,
      "title": "Infrastructure & Builder Classes",
      "focus": "Add builder classes to DOT and Mermaid utility modules, unit tests",
      "tasks": 4,
      "hours": 6,
      "file": "PHASE_13_SPRINT_1_TODO.json",
      "status": "pending"
    },
    {
      "sprint": 2,
      "title": "Critical Files Refactoring",
      "focus": "Refactor 12 files exceeding 1,000 lines to use shared utilities",
      "tasks": 12,
      "hours": 24,
      "file": "PHASE_13_SPRINT_2_TODO.json",
      "status": "pending"
    },
    {
      "sprint": 3,
      "title": "File Splitting & Cleanup",
      "focus": "Split remaining large files, update imports, final integration testing",
      "tasks": 4,
      "hours": 12,
      "file": "PHASE_13_SPRINT_3_TODO.json",
      "status": "pending"
    }
  ],
  "features": {
    "R-1": { "name": "DOT Utility Adoption", "sprints": [1, 2], "status": "pending", "priority": "high" },
    "R-2": { "name": "Mermaid Utility Adoption", "sprints": [1, 2], "status": "pending", "priority": "medium" },
    "R-3": { "name": "ASCII Utility Adoption", "sprints": [2], "status": "pending", "priority": "low" },
    "R-4": { "name": "File Splitting (if needed)", "sprints": [3], "status": "pending", "priority": "medium" }
  },
  "targetMetrics": {
    "dotUtilityAdoption": { "current": "1/22 (4.5%)", "target": "22/22 (100%)" },
    "mermaidUtilityAdoption": { "current": "1/22 (4.5%)", "target": "22/22 (100%)" },
    "asciiUtilityAdoption": { "current": "1/22 (4.5%)", "target": "22/22 (100%)" },
    "filesOver1000Lines": { "current": 12, "target": 0 },
    "totalModeFileLines": { "current": 24046, "target": "18000-19000" }
  },
  "criticalFiles": [
    { "file": "physics.ts", "lines": 1781, "target": "<1000" },
    { "file": "engineering.ts", "lines": 1691, "target": "<1000" },
    { "file": "metareasoning.ts", "lines": 1628, "target": "<1000" },
    { "file": "proof-decomposition.ts", "lines": 1624, "target": "<1000" },
    { "file": "hybrid.ts", "lines": 1450, "target": "<1000" },
    { "file": "formal-logic.ts", "lines": 1290, "target": "<1000" },
    { "file": "scientific-method.ts", "lines": 1257, "target": "<1000" },
    { "file": "optimization.ts", "lines": 1234, "target": "<1000" },
    { "file": "first-principles.ts", "lines": 1224, "target": "<1000" },
    { "file": "mathematics.ts", "lines": 1211, "target": "<1000" },
    { "file": "game-theory.ts", "lines": 1028, "target": "<1000" },
    { "file": "evidential.ts", "lines": 1023, "target": "<1000" }
  ],
  "utilityModules": {
    "dot": { "path": "src/export/visual/utils/dot.ts", "lines": 593, "adoption": "4.5%" },
    "mermaid": { "path": "src/export/visual/utils/mermaid.ts", "lines": 540, "adoption": "4.5%" },
    "ascii": { "path": "src/export/visual/utils/ascii.ts", "lines": 721, "adoption": "4.5%" }
  },
  "referenceImplementation": "src/export/visual/modes/sequential.ts",
  "modifiedFiles": [
    "src/export/visual/utils/dot.ts",
    "src/export/visual/utils/mermaid.ts",
    "src/export/visual/modes/physics.ts",
    "src/export/visual/modes/engineering.ts",
    "src/export/visual/modes/metareasoning.ts",
    "src/export/visual/modes/proof-decomposition.ts",
    "src/export/visual/modes/hybrid.ts",
    "src/export/visual/modes/formal-logic.ts",
    "src/export/visual/modes/scientific-method.ts",
    "src/export/visual/modes/optimization.ts",
    "src/export/visual/modes/first-principles.ts",
    "src/export/visual/modes/mathematics.ts",
    "src/export/visual/modes/game-theory.ts",
    "src/export/visual/modes/evidential.ts"
  ],
  "newFiles": [
    "tests/unit/export/visual/utils/dot-builder.test.ts",
    "tests/unit/export/visual/utils/mermaid-builder.test.ts"
  ],
  "successCriteria": [
    "All 22 mode files use DOT utility functions instead of inline string building",
    "All 22 mode files use Mermaid utility functions",
    "All 22 mode files use ASCII utility functions",
    "All mode files are <1000 lines (may require file splitting)",
    "All 3,539+ tests pass",
    "Visual output is identical before/after (snapshot tests)"
  ],
  "risks": [
    { "risk": "Breaking visual output", "impact": "HIGH", "mitigation": "Snapshot tests for all formats before/after" },
    { "risk": "Regression in specific modes", "impact": "MEDIUM", "mitigation": "Per-mode integration tests" },
    { "risk": "Builder pattern overhead", "impact": "LOW", "mitigation": "Benchmark performance (expected: negligible)" },
    { "risk": "Scope creep", "impact": "MEDIUM", "mitigation": "Strictly limit to utility adoption, no new features" }
  ],
  "outOfScope": [
    "JSON schemas splitting (src/tools/json-schemas.ts)",
    "src/taxonomy/suggestion-engine.ts refactoring",
    "src/services/ThoughtFactory.ts changes",
    "src/export/visual/utils/latex.ts changes"
  ],
  "dependencies": [],
  "notes": "Phase 13 focuses on utility module adoption. The sequential.ts file demonstrates the target pattern: it imports and uses all utility modules, resulting in 805 lines vs 1,781 lines for physics.ts (55% reduction). Currently, 21 out of 22 mode exporters ignore these utilities and duplicate logic inline."
}
