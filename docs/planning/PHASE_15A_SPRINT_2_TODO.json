{
  "phase": "15A",
  "sprint": 2,
  "title": "Simplify Service Layer",
  "week": "Week 2",
  "effort": "5-6 hours",
  "status": "pending",
  "version": "9.0.0",
  "description": "Reduce service layer from 4 classes to 2 essential services. Merge MetaMonitor into SessionManager, merge ModeRouter into ThoughtFactory, inline ExportService dispatch logic.",
  "tasks": [
    {
      "id": "15A.2.1",
      "category": "Architecture",
      "description": "Merge MetaMonitor into SessionManager - Move session metrics tracking directly into SessionManager instead of separate service.",
      "status": "pending",
      "priority": "high",
      "estimatedHours": 1.5,
      "agent": "sonnet",
      "files": {
        "read": [
          "src/services/MetaMonitor.ts"
        ],
        "modify": [
          "src/session/manager.ts"
        ],
        "delete": [
          "src/services/MetaMonitor.ts"
        ]
      },
      "instructions": [
        "Read src/services/MetaMonitor.ts to understand its full API (recordThought, getSessionStats, etc.)",
        "Identify which methods are actually used in src/index.ts handlers",
        "Add essential monitoring methods directly to SessionManager class",
        "Move metric tracking to session-level (store in Session object)",
        "Update all imports in src/index.ts to use SessionManager methods",
        "Delete MetaMonitor.ts",
        "Run npm run typecheck and npm run test:run"
      ],
      "successCriteria": [
        "MetaMonitor.ts deleted",
        "SessionManager has monitoring capabilities",
        "All 5,145+ tests pass",
        "No change to MCP API behavior"
      ],
      "rollbackPlan": "Restore MetaMonitor.ts from git, revert SessionManager changes"
    },
    {
      "id": "15A.2.2",
      "category": "Architecture",
      "description": "Merge ModeRouter into ThoughtFactory - Move mode recommendation logic into ThoughtFactory since it already handles mode-specific logic.",
      "status": "pending",
      "priority": "high",
      "estimatedHours": 1.5,
      "agent": "sonnet",
      "files": {
        "read": [
          "src/services/ModeRouter.ts"
        ],
        "modify": [
          "src/services/ThoughtFactory.ts",
          "src/index.ts"
        ],
        "delete": [
          "src/services/ModeRouter.ts"
        ]
      },
      "instructions": [
        "Read src/services/ModeRouter.ts to understand recommendMode() and quickRecommend() logic",
        "Note: ModeRouter is mostly keyword matching - simple logic",
        "Add recommendMode() and related methods to ThoughtFactory",
        "Inline the routing/recommendation logic",
        "Update handleSwitchMode and handleRecommendMode in index.ts",
        "Delete ModeRouter.ts",
        "Run npm run typecheck and npm run test:run"
      ],
      "successCriteria": [
        "ModeRouter.ts deleted",
        "ThoughtFactory has mode recommendation methods",
        "All tests pass"
      ],
      "rollbackPlan": "Restore ModeRouter.ts from git, revert ThoughtFactory changes"
    },
    {
      "id": "15A.2.3",
      "category": "Architecture",
      "description": "Inline ExportService Dispatch Logic - Move export format dispatch to index.ts handler, keep format-specific exporters separate.",
      "status": "pending",
      "priority": "medium",
      "estimatedHours": 1.0,
      "agent": "haiku",
      "files": {
        "read": [
          "src/services/ExportService.ts"
        ],
        "modify": [
          "src/index.ts",
          "src/services/ExportService.ts"
        ]
      },
      "instructions": [
        "Read src/services/ExportService.ts to identify dispatch switch statement",
        "Move format dispatch switch to deepthinking_session export handler in index.ts",
        "Keep ExportService for format-specific export logic only",
        "Consider renaming ExportService to clarify its reduced role",
        "Run npm run test:run"
      ],
      "successCriteria": [
        "Export dispatch in index.ts handler",
        "ExportService simplified",
        "All tests pass"
      ],
      "rollbackPlan": "Revert index.ts and ExportService changes"
    },
    {
      "id": "15A.2.4",
      "category": "Cleanup",
      "description": "Remove Unused Cache Strategies - Keep only LRU cache (most practical), remove LFU and FIFO variants.",
      "status": "pending",
      "priority": "low",
      "estimatedHours": 0.5,
      "agent": "haiku",
      "files": {
        "read": [
          "src/cache/factory.ts",
          "src/cache/lru.ts"
        ],
        "modify": [
          "src/session/manager.ts",
          "src/cache/index.ts"
        ],
        "delete": [
          "src/cache/factory.ts",
          "src/cache/lfu.ts",
          "src/cache/fifo.ts"
        ]
      },
      "instructions": [
        "Verify only LRU cache is actually used in production code",
        "Search for CacheFactory, LFUCache, FIFOCache usage",
        "Update SessionManager to use LRU directly (not via factory)",
        "Delete unused cache files",
        "Update cache/index.ts barrel",
        "Run npm run test:run"
      ],
      "successCriteria": [
        "Only LRU cache remains",
        "3 cache files deleted",
        "All tests pass"
      ],
      "rollbackPlan": "Restore cache files from git"
    },
    {
      "id": "15A.2.5",
      "category": "Verification",
      "description": "Sprint 2 Verification - Run full test suite, create commit, update documentation.",
      "status": "pending",
      "priority": "high",
      "estimatedHours": 1.0,
      "agent": "sonnet",
      "files": {
        "verify": [
          "All modified files"
        ],
        "modify": [
          "docs/planning/PHASE_15A_SPRINT_2_TODO.json"
        ]
      },
      "instructions": [
        "Run npm run typecheck - must pass with 0 errors",
        "Run npm run test:run - all tests must pass",
        "Run npm run build - must complete successfully",
        "Create git commit: 'refactor(v9.0.0): Phase 15A Sprint 2 - Simplify Service Layer'",
        "Update this TODO file with actual hours and completion status"
      ],
      "successCriteria": [
        "All tasks 15A.2.1-15A.2.4 complete",
        "Build passes",
        "All tests pass",
        "Git commit created"
      ]
    }
  ],
  "successCriteria": [
    "MetaMonitor merged into SessionManager",
    "ModeRouter merged into ThoughtFactory",
    "ExportService dispatch inlined",
    "Unused cache strategies removed",
    "Service layer reduced from 4 to 2 classes",
    "All tests pass"
  ],
  "expectedReduction": {
    "linesOfCode": 1500,
    "files": 5,
    "classes": 2
  },
  "notes": "Sprint 2 consolidates services to reduce cognitive load. MetaMonitor and ModeRouter are thin wrappers that add indirection without value."
}
